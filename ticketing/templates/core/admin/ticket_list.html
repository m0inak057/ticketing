{% extends 'core/admin/base_admin.html' %}
{% block title %}Manage Tickets{% endblock %}
{% block admin_content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-blue-600">Tickets</h2>
        <div class="flex space-x-3">
            <a href="{% url 'admin_create_ticket' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Create New Ticket</a>
            {% if tickets %}
            <button onclick="confirmDeleteAll()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                <i class="fas fa-trash mr-2"></i>Delete All Tickets
            </button>
            {% endif %}
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full table-auto">
            <thead>
                <tr class="bg-blue-50">
                    <th class="px-4 py-2 text-left">Ticket #</th>
                    <th class="px-4 py-2 text-left">Event</th>
                    <th class="px-4 py-2 text-left">Type</th>
                    <th class="px-4 py-2 text-left">Status</th>
                    <th class="px-4 py-2 text-left">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr class="border-b">
                    <td class="px-4 py-2">{{ ticket.ticket_number }}</td>
                    <td class="px-4 py-2">{{ ticket.event.title }}</td>
                    <td class="px-4 py-2">{{ ticket.ticket_type }}</td>
                    <td class="px-4 py-2">{{ ticket.status }}</td>
                    <td class="px-4 py-2">
                        <a href="{% url 'admin_edit_ticket' ticket.id %}" class="text-blue-600 hover:text-blue-500 mr-2">Edit</a>
                        <a href="{% url 'admin_delete_ticket' ticket.id %}" class="text-red-600 hover:text-red-500" onclick="return confirm('Are you sure you want to delete this ticket?')">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-gray-600 px-4 py-2">No tickets found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Delete All Confirmation Modal -->
<div id="deleteAllModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Delete All Tickets</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you absolutely sure you want to delete ALL tickets? This action cannot be undone and will permanently remove:
                </p>
                <div class="mt-4 text-left bg-red-50 p-3 rounded">
                    <ul class="text-sm text-red-700 space-y-1">
                        <li>• All ticket records ({{ tickets.count }} tickets)</li>
                        <li>• All purchase history</li>
                        <li>• All QR codes will become invalid</li>
                        <li>• Customer ticket access will be lost</li>
                    </ul>
                </div>
                <p class="text-sm text-gray-600 mt-4 font-semibold">
                    Type "DELETE ALL TICKETS" below to confirm:
                </p>
                <input type="text" id="confirmationText" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Type confirmation text here">
            </div>
            <div class="items-center px-4 py-3">
                <div class="flex space-x-3">
                    <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button onclick="executeDeleteAll()" id="deleteButton" disabled class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Delete All Tickets
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDeleteAll() {
    document.getElementById('deleteAllModal').classList.remove('hidden');
    document.getElementById('confirmationText').value = '';
    document.getElementById('deleteButton').disabled = true;
}

function closeDeleteModal() {
    document.getElementById('deleteAllModal').classList.add('hidden');
}

// Enable delete button only when correct confirmation text is entered
document.getElementById('confirmationText').addEventListener('input', function() {
    const confirmText = this.value;
    const deleteButton = document.getElementById('deleteButton');
    
    if (confirmText === 'DELETE ALL TICKETS') {
        deleteButton.disabled = false;
        deleteButton.classList.remove('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
    } else {
        deleteButton.disabled = true;
        deleteButton.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
    }
});

function executeDeleteAll() {
    const confirmText = document.getElementById('confirmationText').value;
    
    if (confirmText !== 'DELETE ALL TICKETS') {
        alert('Please type the exact confirmation text to proceed.');
        return;
    }
    
    // Show loading state
    const deleteButton = document.getElementById('deleteButton');
    deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
    deleteButton.disabled = true;
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "admin_delete_all_tickets" %}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = '{{ csrf_token }}';
    form.appendChild(csrfToken);
    
    document.body.appendChild(form);
    form.submit();
}

// Close modal when clicking outside
document.getElementById('deleteAllModal').addEventListener('click', function(event) {
    if (event.target === this) {
        closeDeleteModal();
    }
});
</script>
{% endblock %}
