{% extends 'base.html' %}
{% load static %}

{% block title %}Promo Code Analytics - TapNex's Ticketing System{% endblock %}

{% block extra_css %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ApexCharts for additional visualizations -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="bg-gradient-to-r from-purple-600 via-purple-500 to-pink-500 py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <div class="flex justify-center mb-6">
                <div class="relative">
                    <div class="w-24 h-24 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center border-4 border-white/30">
                        <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zm7-10a1 1 0 01.707.293l.707.707L15.414 5a1 1 0 01-1.414 1.414L13 5.414V17a1 1 0 11-2 0V5.414L9.707 6.707a1 1 0 01-1.414-1.414l2-2A1 1 0 0112 2z" />
                        </svg>
                    </div>
                </div>
            </div>
            <h1 class="text-4xl lg:text-5xl font-black text-white mb-4 animate-fade-in">
                Promo Code Analytics Hub
            </h1>
            <p class="text-xl text-white/90 max-w-2xl mx-auto animate-slide-up">
                Track performance, revenue impact, and redemption metrics for all your promotion codes
            </p>
        </div>
    </div>
</div>

<!-- Main Controls -->
<div class="bg-tapnex-gray border-b border-gray-200 sticky top-0 z-10 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-wrap items-center justify-between py-4">
            <div class="flex items-center space-x-4">
                <h2 class="text-xl font-bold text-purple-600">Promo Code Analytics</h2>
                <div class="text-sm text-gray-500">Last updated: {% now "M d, Y, g:i a" %}</div>
            </div>
            <div class="flex items-center space-x-3 mt-3 sm:mt-0">
                <a href="{% url 'dashboard' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-tapnex-blue hover:bg-tapnex-dark transition-colors duration-300">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                    Return to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Content -->
<div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    {% if promo_codes %}
    
    <!-- KPI Stats Overview -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Key Performance Metrics</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Active Promo Codes -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-900">Active Promos</h3>
                    </div>
                </div>
                <div class="text-3xl font-bold text-green-600">{{ promo_codes|length }}</div>
            </div>

            <!-- Total Discount Given -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 4a1 1 0 000 2h6a1 1 0 100-2H7zm1 5a1 1 0 011-1h4a1 1 0 110 2h-4a1 1 0 01-1-1zm0 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-900">Total Saved</h3>
                    </div>
                </div>
                <div class="text-3xl font-bold text-purple-600">
                    ₹{{ promo_codes|dictsortreversed:"amount_saved"|first|default:"0"|stringformat:".2f" }}
                </div>
            </div>

            <!-- Total Revenue Through Promos -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-900">Revenue Generated</h3>
                    </div>
                </div>
                <div class="text-3xl font-bold text-blue-600">
                    ₹{{ promo_codes|dictsortreversed:"revenue_generated"|first|default:"0"|stringformat:".2f" }}
                </div>
            </div>

            <!-- Avg Redemption Rate -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 hover:shadow-xl transition-all duration-300">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-900">Avg Redemption</h3>
                    </div>
                </div>
                <div class="text-3xl font-bold text-orange-600">
                    {{ promo_codes|dictsortreversed:"redemption_rate"|first|default:"0"|stringformat:".1f" }}%
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-12">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Search & Filter Promo Codes</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label for="promo-search" class="block text-sm font-medium text-gray-700 mb-1">Search by Code</label>
                <input type="text" id="promo-search" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter promo code...">
            </div>
            
            <div>
                <label for="event-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Event</label>
                <select id="event-filter" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">All Events</option>
                    {% for code in promo_codes %}
                        <option value="{{ code.event.id }}">{{ code.event.title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
                <select id="status-filter" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="expired">Expired</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Promo Code Listing with Enhanced Details -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-12 overflow-hidden">
        <h2 class="text-xl font-bold text-gray-900 mb-6">Promo Code Performance</h2>
        
        <div class="overflow-x-auto">
            <table class="min-w-full table-auto" id="promo-codes-table">
                <thead>
                    <tr class="bg-gray-50 text-gray-600 text-sm uppercase tracking-wider">
                        <th class="px-6 py-3 text-left">Code</th>
                        <th class="px-6 py-3 text-left">Event</th>
                        <th class="px-6 py-3 text-left">Type</th>
                        <th class="px-6 py-3 text-left">Value</th>
                        <th class="px-6 py-3 text-left">Usage</th>
                        <th class="px-6 py-3 text-left">Tickets</th>
                        <th class="px-6 py-3 text-left">Savings</th>
                        <th class="px-6 py-3 text-left">Revenue</th>
                        <th class="px-6 py-3 text-left">Redemption</th>
                        <th class="px-6 py-3 text-left">Avg Order</th>
                        <th class="px-6 py-3 text-left">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for code in promo_codes %}
                    <tr class="border-b hover:bg-gray-50 promo-code-row" data-event="{{ code.event.id }}" data-code="{{ code.code|lower }}" data-status="{% if code.is_active %}active{% else %}inactive{% endif %}{% if not code.is_valid %}expired{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-purple-600">{{ code.code }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ code.event.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ code.get_discount_type_display }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if code.discount_type == 'PERCENTAGE' %}
                                {{ code.discount_value }}%
                            {% else %}
                                ₹{{ code.discount_value }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="mr-2">{{ code.current_uses }}/{% if code.max_uses == 0 %}∞{% else %}{{ code.max_uses }}{% endif %}</span>
                                {% if code.max_uses > 0 %}
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: {{ code.current_uses|floatformat:0|default:0|safe }}%"></div>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ code.tickets_booked }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-green-600 font-medium">₹{{ code.amount_saved|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-blue-600 font-medium">₹{{ code.revenue_generated|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="mr-2">{{ code.redemption_rate|floatformat:1 }}%</span>
                                <div class="w-16 bg-gray-200 rounded-full h-2">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: {{ code.redemption_rate|floatformat:0|default:0|safe }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">₹{{ code.average_order_value|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if code.is_active and code.is_valid %}
                                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Active</span>
                            {% elif code.is_active and not code.is_valid %}
                                <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">Expired</span>
                            {% else %}
                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Inactive</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Data Visualizations -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
        <!-- Promo Code Redemption Rate Chart -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Redemption Rate by Promo Code</h3>
            <div id="redemption-rate-chart" style="height: 300px;"></div>
        </div>
        
        <!-- Revenue vs Savings Chart -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue vs Discount by Promo Code</h3>
            <div id="revenue-savings-chart" style="height: 300px;"></div>
        </div>
    </div>

    {% else %}
    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zm7-10a1 1 0 01.707.293l.707.707L15.414 5a1 1 0 01-1.414 1.414L13 5.414V17a1 1 0 11-2 0V5.414L9.707 6.707a1 1 0 01-1.414-1.414l2-2A1 1 0 0112 2z" clip-rule="evenodd" />
        </svg>
        <h2 class="text-2xl font-bold text-gray-700 mb-2">No Promo Codes Found</h2>
        <p class="text-gray-600 mb-6">You don't have any promo codes for your events. Contact an admin to create promo codes for your events.</p>
        <div class="flex justify-center space-x-4">
            <a href="{% url 'dashboard' %}" class="bg-tapnex-blue text-white px-6 py-2 rounded-lg hover:bg-tapnex-dark transition-colors font-medium">
                Return to Dashboard
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter functionality
        const promoSearch = document.getElementById('promo-search');
        const eventFilter = document.getElementById('event-filter');
        const statusFilter = document.getElementById('status-filter');
        const promoRows = document.querySelectorAll('.promo-code-row');
        
        function filterTable() {
            const searchTerm = promoSearch.value.toLowerCase();
            const eventId = eventFilter.value;
            const status = statusFilter.value;
            
            promoRows.forEach(row => {
                const codeMatches = row.dataset.code.includes(searchTerm);
                const eventMatches = !eventId || row.dataset.event === eventId;
                const statusMatches = !status || row.dataset.status === status;
                
                if (codeMatches && eventMatches && statusMatches) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        promoSearch.addEventListener('input', filterTable);
        eventFilter.addEventListener('change', filterTable);
        statusFilter.addEventListener('change', filterTable);
        
        {% if promo_codes %}
        // Prepare data for charts
        const promoLabels = [{% for code in promo_codes %}'{{ code.code }}',{% endfor %}];
        const redemptionData = [{% for code in promo_codes %}{{ code.redemption_rate|floatformat:1 }},{% endfor %}];
        const revenueData = [{% for code in promo_codes %}{{ code.revenue_generated|floatformat:2 }},{% endfor %}];
        const savingsData = [{% for code in promo_codes %}{{ code.amount_saved|floatformat:2 }},{% endfor %}];
        
        // Redemption Rate Chart
        if(document.getElementById('redemption-rate-chart')) {
            const redemptionChartOptions = {
                series: [{
                    name: 'Redemption Rate',
                    data: redemptionData
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: false,
                    }
                },
                colors: ['#8b5cf6'],
                xaxis: {
                    categories: promoLabels,
                    labels: {
                        style: {
                            fontFamily: 'Inter, sans-serif'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Redemption Rate (%)'
                    }
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + "%";
                        }
                    }
                }
            };
            
            const redemptionChart = new ApexCharts(document.getElementById('redemption-rate-chart'), redemptionChartOptions);
            redemptionChart.render();
        }
        
        // Revenue vs Savings Chart
        if(document.getElementById('revenue-savings-chart')) {
            const revenueChartOptions = {
                series: [{
                    name: 'Revenue Generated',
                    data: revenueData
                }, {
                    name: 'Discount Given',
                    data: savingsData
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    },
                    stacked: false,
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: false,
                    }
                },
                colors: ['#3b82f6', '#10b981'],
                xaxis: {
                    categories: promoLabels,
                    labels: {
                        style: {
                            fontFamily: 'Inter, sans-serif'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Amount (₹)'
                    }
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return "₹" + val;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'left'
                }
            };
            
            const revenueChart = new ApexCharts(document.getElementById('revenue-savings-chart'), revenueChartOptions);
            revenueChart.render();
        }
        {% endif %}
    });
</script>
{% endblock %}
